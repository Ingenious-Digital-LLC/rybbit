name: Upstream Sync

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9am UTC
  workflow_dispatch:       # Manual trigger

jobs:
  sync:
    name: Check & Sync Upstream
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/rybbit-io/rybbit.git || true
          git fetch upstream master

      - name: Check for new commits
        id: check
        run: |
          BEHIND=$(git rev-list --count HEAD..upstream/master)
          echo "behind=$BEHIND" >> $GITHUB_OUTPUT
          echo "Upstream is $BEHIND commits ahead"

          if [ "$BEHIND" -gt 0 ]; then
            LATEST_TAG=$(git tag -l 'v*' --sort=-v:refname | head -1)
            UPSTREAM_TAG=$(git ls-remote --tags upstream 'refs/tags/v*' | awk '{print $2}' | sed 's|refs/tags/||' | sort -V | tail -1)
            echo "latest_local_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
            echo "latest_upstream_tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT

            # Get commit summary
            SUMMARY=$(git log --oneline HEAD..upstream/master | head -20)
            echo "summary<<EOF" >> $GITHUB_OUTPUT
            echo "$SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create sync branch and PR
        if: steps.check.outputs.behind > 0
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="upstream-sync/$(date +%Y%m%d)"
          git checkout -b "$BRANCH"
          git merge upstream/master --no-edit || {
            echo "::warning::Merge conflicts detected. Manual resolution needed."
            git merge --abort
            # Create PR with conflict notice
            gh pr create \
              --title "Upstream sync: ${{ steps.check.outputs.behind }} new commits (conflicts)" \
              --body "$(cat <<'EOF'
          ## Upstream Sync

          **${{ steps.check.outputs.behind }}** new commits from [rybbit-io/rybbit](https://github.com/rybbit-io/rybbit).

          > Merge conflicts detected. Manual resolution required.

          **Latest upstream tag**: ${{ steps.check.outputs.latest_upstream_tag }}
          **Our latest tag**: ${{ steps.check.outputs.latest_local_tag }}

          ### Recent commits
          ```
          ${{ steps.check.outputs.summary }}
          ```
          EOF
          )" \
              --label "upstream-sync"
            exit 0
          }

          git push origin "$BRANCH"

          gh pr create \
            --title "Upstream sync: ${{ steps.check.outputs.behind }} new commits" \
            --body "$(cat <<'EOF'
          ## Upstream Sync

          **${{ steps.check.outputs.behind }}** new commits from [rybbit-io/rybbit](https://github.com/rybbit-io/rybbit).

          **Latest upstream tag**: ${{ steps.check.outputs.latest_upstream_tag }}
          **Our latest tag**: ${{ steps.check.outputs.latest_local_tag }}

          ### Recent commits
          ```
          ${{ steps.check.outputs.summary }}
          ```

          Merging this PR will trigger the Docker build + deploy pipeline.
          EOF
          )" \
            --label "upstream-sync"
